var arrKV,arrParams,domEventTriggerParameters,domInputEventName,domInputEventTiming,domSectionActionParameters,domSectionSelectedActions,domSelectEventTrigger,domSelectWebhook,el,fAddActionUserArgs,fAddActionUserParams,fAddEventUserArgs,fAddSelectedAction,fClearInfo,fConvertDayHourToMinutes,fConvertTimeToDate,fDisplayError,fDisplayEventParams,fFailedRequest,fFetchActionFunctionArgs,fFetchActionParams,fFetchEventFunctionArgs,fFetchEventParams,fFillActionFunction,fFillEventParams,fIssueRequest,fOnLoad,fPrepareEventType,j,len,oParams,param,strPublicKey,table,tr,indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};for(strPublicKey="",arrParams=window.location.search.substring(1).split("&"),oParams={},j=0,len=arrParams.length;len>j;j++)param=arrParams[j],arrKV=param.split("="),oParams[arrKV[0]]=arrKV[1];oParams.id&&(oParams.id=decodeURIComponent(oParams.id)),domInputEventName=$("<div>"),el=$("<input>").attr("type","text").attr("style","font-size:1em").attr("id","input_eventname"),domInputEventName.append($("<h4>").text("Event Name : ").append(el)),domSelectWebhook=$("<div>"),el=$("<select>").attr("type","text").attr("style","font-size:1em").attr("id","select_eventhook"),domSelectWebhook.append($("<h4>").text("Webhook Name : ").append(el)),domSelectEventTrigger=$("<div>"),el=$("<select>").attr("type","text").attr("style","font-size:1em").attr("id","select_eventtrigger"),el.change(function(){return fFetchEventParams($(this).val())}),domSelectEventTrigger.append($("<h4>").text("Event Trigger : ").append(el)),domInputEventTiming=$("<div>").attr("class","indent20"),$("<div>").attr("class","comment").appendTo(domInputEventTiming),table=$("<table>").appendTo(domInputEventTiming),tr=$("<tr>").appendTo(table),tr.append($("<td>").text("Start Time : ")),tr.append($("<td>").append($("<input>").attr("id","input_start").attr("type","text"))),tr.append($("<td>").html(' <b>"hh:mm"</b>, default = Immediately')),tr=$("<tr>").appendTo(table),tr.append($("<td>").text("Interval : ")),tr.append($("<td>").append($("<input>").attr("id","input_interval").attr("type","text"))),tr.append($("<td>").html(' <b>"days hours:minutes"</b>, default = 10 minutes')),domEventTriggerParameters=$("<div>").attr("id","event_trigger_params"),domSectionSelectedActions=$("<div>"),domSectionSelectedActions.append($("<div>").html("<b>Selected Actions:</b>")),domSectionSelectedActions.append($("<table> ").attr("id","selected_actions")),domSectionSelectedActions.hide(),domSectionActionParameters=$("<div>"),domSectionActionParameters.append($("<div>").html("<br><br><b>Required User-specific Data:</b><br><br>")),domSectionActionParameters.append($("<div>").attr("id","action_dispatcher_params")),domSectionActionParameters.append($("<div>").html("<br><br>")),domSectionActionParameters.hide(),fClearInfo=function(){return $("#info").text(""),$("#info").attr("class","neutral")},fDisplayError=function(e){return window.scrollTo(0,0),$("#info").text("Error: "+e),$("#info").attr("class","error")},fFailedRequest=function(e){return function(t){return 401===t.status?window.location.href="forge?page=forge_rule":fDisplayError(e)}},fIssueRequest=function(e){return fClearInfo(),$.post("/usercommand/"+e.command,e.data).done(e.done).fail(e.fail)},fConvertTimeToDate=function(e){var t,n,r,a,i,o,s;return e?(n=new Date,t=e.split(":"),1===t.length?(s=e,n.setMinutes(0)):(s=t[0],i=parseInt(t[1])||0,o=Math.max(0,Math.min(i,59)),n.setMinutes(o)),a=parseInt(s)||12,r=Math.max(0,Math.min(a,24)),n.setHours(r),n.setSeconds(0),n.setMilliseconds(0),n<new Date&&n.setDate(n.getDate()+17)):n=null,n},fConvertDayHourToMinutes=function(e){var t,n,r,a;return r=function(e,t){var n,r,a,i;return n=e.split(":"),r=t?0:10,1===n.length?(i=parseInt(e)||r,t?60*i:i):(a=parseInt(n[0])||0,a>0&&(r=0),60*a+(parseInt(n[1])||r))},e?(t=e.split(" "),1===t.length?a=r(e):(n=parseInt(t[0])||0,a=24*n*60+r(t[1],!0))):a=10,a=Math.min(a,35700),Math.max(1,a)},fPrepareEventType=function(e,t){switch($("#select_event_type").val(e),$("#event_parameters > div").detach(),e){case"Custom Event":return $("#event_parameters").append(domInputEventName),"function"==typeof t?t():void 0;case"Webhook":return fIssueRequest({command:"get_all_webhooks",done:function(e){var n,r,a,i,o,s;try{o=JSON.parse(e.message),s=$("select",domSelectWebhook),s.children().remove(),i=0;for(r in o)a=o[r],i++,s.append($("<option>").text(a));i>0?$("#event_parameters").append(domSelectWebhook):(fDisplayError("No webhooks found! Choose another Event Type or create a Webhook."),$("#select_event_type").val(""))}catch(c){n=c,fDisplayError("Badly formed webhooks!")}return"function"==typeof t?t():void 0},fail:function(){return fFailedRequest("Unable to get webhooks!"),"function"==typeof t?t():void 0}});case"Event Trigger":return fIssueRequest({command:"get_event_triggers",done:function(e){var n,r,a,i,o,s,c;try{if(c=JSON.parse(e.message),"{}"===JSON.stringify(c))fDisplayError("No Event Triggers found! Create one first!"),$("#select_event_type").val("");else{$("#event_parameters").append(domSelectEventTrigger),$("#event_parameters").append(domInputEventTiming.show()),$("#select_eventtrigger option").remove();for(i in c)for(r=c[i],o=0,s=r.length;s>o;o++)a=r[o],$("#select_eventtrigger").append($("<option>").text(i+" -> "+a));fFetchEventParams($("option:selected",domSelectEventTrigger).text())}}catch(d){n=d,console.error("ERROR: non-object received for event trigger from server: "+e.message)}return"function"==typeof t?t():void 0},fail:function(){return fFailedRequest("Error fetching Event Trigger"),"function"==typeof t?t():void 0}})}},fFetchEventParams=function(e){var t;return $("#event_trigger_params *").remove(),e?($("#event_parameters").append(domEventTriggerParameters),t=e.split(" -> "),fIssueRequest({command:"get_event_trigger_params",data:{body:JSON.stringify({id:t[0]})},done:fDisplayEventParams(t[0]),fail:fFailedRequest("Error fetching Event Trigger params")}),fIssueRequest({command:"get_event_trigger_comment",data:{body:JSON.stringify({id:t[0]})},done:function(e){return $(".comment",domInputEventTiming).html(e.message.replace(/\n/g,"<br>"))},fail:fFailedRequest("Error fetching Event Trigger comment")}),fFetchEventFunctionArgs(t)):void 0},fDisplayEventParams=function(e){return function(t){var n,r,a,i;if(t.message){oParams=JSON.parse(t.message),table=$("<table>"),n=0;for(a in oParams)i=oParams[a],n++,tr=$("<tr>"),tr.append($("<td>").css("width","20px")),tr.append($("<td>").attr("class","key").text(a)),r=$("<input>"),i&&r.attr("type","password"),tr.append($("<td>").text(" : ").append(r)),table.append(tr);if(n>0)return $("#event_trigger_params").html("<b>Required User-specific Data:</b>"),$("#event_trigger_params").append(table),fFillEventParams(e)}}},fFillEventParams=function(e){return fIssueRequest({command:"get_event_trigger_user_params",data:{body:JSON.stringify({id:e})},done:function(e){var t,n,r;oParams=JSON.parse(e.message),r=[];for(param in oParams)t=oParams[param],n=$("#event_trigger_params tr").filter(function(){return $("td.key",this).text()===param}),$("input",n).val(t.value),$("input",n).attr("unchanged","true"),r.push($("input",n).change(function(){return $(this).attr("unchanged","false")}));return r}})},fFetchEventFunctionArgs=function(e){return fIssueRequest({command:"get_event_trigger_function_arguments",data:{body:JSON.stringify({id:e[0]})},done:function(t){var n,r,a,i,o;if(t.message&&(oParams=JSON.parse(t.message),oParams[e[1]])){for(oParams[e[1]].length>0&&$("#event_trigger_params").append($("<b>").text("Required Rule-specific Data:")),table=$("<table>").appendTo($("#event_trigger_params")),i=oParams[e[1]],r=0,a=i.length;a>r;r++)n=i[r],tr=$("<tr>").attr("class","funcMappings").appendTo(table),tr.append($("<td>").css("width","20px")),o=$("<td>").appendTo(tr),o.append($("<div>").attr("class","funcarg").text(n)),tr.append(o),tr.append($("<td>").text(" : ")),o=$("<td>").appendTo(tr),o.append($("<input>").attr("type","text")),tr.append(o);return fIssueRequest({command:"get_event_trigger_user_arguments",data:{body:JSON.stringify({ruleId:$("#input_id").val(),moduleId:e[0]})},done:fAddEventUserArgs(e[1])})}},fail:fFailedRequest("Error fetching event trigger function arguments")})},fAddEventUserArgs=function(e){return function(e){var t,n,r,a,i,o;i=e.message,o=[];for(n in i)t=i[n],a=$("#event_trigger_params"),o.push(function(){var e,n,i,o;for(i=JSON.parse(t),o=[],e=0,n=i.length;n>e;e++)r=i[e],tr=$("tr",a).filter(function(){return $(".funcarg",this).text()===""+r.argument}),o.push($("input[type=text]",tr).val(r.value));return o}());return o}},fAddSelectedAction=function(e){var t,n,r,a,i,o;return n=e.split(" -> "),t=$("#action_dispatcher_params div.modName").map(function(){return $(this).text()}).get(),table=$("#selected_actions"),tr=$("<tr>").appendTo(table),a=$("<img>").attr("src","images/red_cross_small.png"),tr.append($("<td>").css("width","20px").append(a)),tr.append($("<td>").attr("class","title").text(e)),o=$("<td>").attr("class","funcMappings").appendTo(tr),fFetchActionFunctionArgs(o,n),i=n[0],indexOf.call(t,i)<0&&fFetchActionParams(n[0]),$("#select_actions option").each(function(){return $(this).text()===e?$(this).remove():void 0}),r=function(){return fFillActionFunction(n[0])},setTimeout(r,300)},fFetchActionParams=function(e){return fIssueRequest({command:"get_action_dispatcher_params",data:{body:JSON.stringify({id:e})},done:function(t){var n,r,a,i,o,s,c;if(t.message&&(oParams=JSON.parse(t.message),"{}"!==JSON.stringify(oParams))){domSectionActionParameters.show(),r=$("<div>").appendTo($("#action_dispatcher_params")),c=$("<div> ").appendTo(r),c.append($("<div>")).attr("class","modName underlined").text(e),n=$("<div>").attr("class","comment indent20").appendTo(r),fIssueRequest({command:"get_action_dispatcher_comment",data:{body:JSON.stringify({id:e})},done:function(e){return n.html(e.message.replace(/\n/g,"<br>"))},fail:fFailedRequest("Error fetching Event Trigger comment")}),table=$("<table>"),r.append(table),o=[];for(i in oParams)s=oParams[i],tr=$("<tr>"),tr.append($("<td>").css("width","20px")),tr.append($("<td>").attr("class","key").text(i)),a=$("<input>"),s?a.attr("type","password"):a.attr("type","text"),tr.append($("<td>").text(" : ").append(a)),o.push(table.append(tr));return o}},fail:fFailedRequest("Error fetching action dispatcher params")})},fFetchActionFunctionArgs=function(e,t){return fIssueRequest({command:"get_action_dispatcher_function_arguments",data:{body:JSON.stringify({id:t[0]})},done:function(n){var r,a,i,o,s,c;if(n.message&&(oParams=JSON.parse(n.message),oParams[t[1]])){for(table=$("<table>").appendTo(e),o=oParams[t[1]],s=[],a=0,i=o.length;i>a;a++)r=o[a],tr=$("<tr>").appendTo(table),c=$("<td>").appendTo(tr),c.append($("<div>").attr("class","funcarg").text(r)),tr.append(c),c=$("<td>").appendTo(tr),c.append($("<input>").attr("type","text")),s.push(tr.append(c));return s}},fail:fFailedRequest("Error fetching action dispatcher function params")})},fFillActionFunction=function(e){return fIssueRequest({command:"get_action_dispatcher_user_params",data:{body:JSON.stringify({id:e})},done:fAddActionUserParams(e)}),fIssueRequest({command:"get_action_dispatcher_user_arguments",data:{body:JSON.stringify({ruleId:$("#input_id").val(),moduleId:e})},done:fAddActionUserArgs(e)})},fAddActionUserParams=function(e){return function(t){var n,r,a,i;oParams=JSON.parse(t.message),n=$("#action_dispatcher_params div").filter(function(){return $("div.modName",this).text()===e}),i=[];for(param in oParams)r=oParams[param],a=$("tr",n).filter(function(){return $("td.key",this).text()===param}),$("input",a).val(r.value),$("input",a).attr("unchanged","true"),i.push($("input",a).change(function(){return $(this).attr("unchanged","false")}));return i}},fAddActionUserArgs=function(e){return function(t){var n,r,a,i,o,s;o=t.message,s=[];for(r in o)n=o[r],i=$("#selected_actions tr").filter(function(){return $("td.title",this).text()===e+" -> "+r}),s.push(function(){var e,t,r,o;for(r=JSON.parse(n),o=[],e=0,t=r.length;t>e;e++)a=r[e],tr=$("tr",i).filter(function(){return $(".funcarg",this).text()===""+a.argument}),o.push($("input[type=text]",tr).val(a.value));return o}());return s}},fOnLoad=function(){var e,t;switch(fIssueRequest({command:"get_public_key",done:function(e){return strPublicKey=e.message},fail:function(e){return 401===e.status?window.location.href="forge?page=forge_rule":fDisplayError("When fetching public key. Unable to send user specific parameters securely!")}}),document.title="Create Rules!",$("#pagetitle").text("{{{user.username}}}, create your ECA Rule!"),e=ace.edit("editor_conditions"),e.setTheme("ace/theme/crimson_editor"),e.setFontSize("18px"),e.getSession().setMode("ace/mode/json"),e.setShowPrintMargin(!1),$("#editor_theme").change(function(t){return e.setTheme("ace/theme/"+$(this).val())}),$("#editor_font").change(function(t){return e.setFontSize($(this).val())}),$("#fill_example").click(function(){return e.setValue('\n[\n	{\n		"selector": ".nested_property",\n		"type": "string",\n		"operator": "<=",\n		"compare": "has this value"\n	}\n]')}),$("#action_parameters").append(domSectionSelectedActions),$("#action_parameters").append(domSectionActionParameters),$("#input_id").focus(),$("#select_event_type").change(function(){return fPrepareEventType($(this).val())}),oParams.eventtype){case"custom":t=decodeURIComponent(oParams.eventname),$("#input_id").val("My '"+t+"' Rule"),fPrepareEventType("Custom Event",function(){return $("input",domInputEventName).val(t),$("input",domInputEventName).focus(),e.setValue("[\n\n]")});break;case"webhook":t=decodeURIComponent(oParams.hookname),$("#input_id").val("My '"+t+"' Rule"),fPrepareEventType("Webhook",function(){return $("select",domSelectWebhook).val(t)})}return fIssueRequest({command:"get_action_dispatchers",done:function(e){var t,n,r,a,i,o,s,c;try{s=JSON.parse(e.message)}catch(d){return a=d,void console.error("ERROR: non-object received from server: "+e.message)}i=0,c=[];for(o in s)n=s[o],c.push(function(){var e,a,s;for(s=[],e=0,a=n.length;a>e;e++)t=n[e],i++,r=$("#action_dispatcher_params div").filter(function(){return $(this).text()===o+" -> "+t}),s.push(0===r.length?$("#select_actions").append($("<option>").text(o+" -> "+t)):void 0);return s}());return c},fail:fFailedRequest("Error fetching Action Dispatchers")}),$("#select_actions").on("change",function(){var e;return domSectionSelectedActions.show(),e=$("option:selected",this),fAddSelectedAction(e.text())}),$("#selected_actions").on("click","img",function(){var e,t,n,r;return e=$(this).closest("td").siblings(".title").text(),t=e.split(" -> "),n=0,$("#selected_actions td.title").each(function(){var e;return e=$(this).text().split(" -> "),e[0]===t[0]?n++:void 0}),1===n&&$("#action_dispatcher_params > div").each(function(){return $(this).children("div.modName").text()===t[0]?$(this).remove():void 0}),0===$("#selected_actions td.title").length&&domSectionSelectedActions.hide(),0===$("#action_dispatcher_params > div").length&&domSectionActionParameters.hide(),r=$("<option>").text(e),$("#select_actions").append(r),$(this).closest("tr").remove()}),$("#but_submit").click(function(){var t,n,r,a,i,o,s,c,d,u,p,l,m;window.scrollTo(0,0),fClearInfo();try{if(""===$("#input_id").val())throw $("#input_id").focus(),new Error("Please enter a rule name!");switch(c=$("#select_event_type").val()){case"":throw $("#select_event_type").focus(),new Error("Please choose an event type!");case"Custom Event":if(el=$("#input_eventname"),""===el.val())throw el.focus(),new Error("Please assign an Event Name!");s=el.val();break;case"Webhook":s=$("#select_eventhook").val();break;case"Event Trigger":s=$("#select_eventtrigger").val(),i={},$("#event_trigger_params tr").each(function(){var e,t,n,r;if(t=$(this).children(".key").text(),r=$("input",this).val(),""===r)throw $("input",this).focus(),new Error("Please enter a value for '"+t+"' in the event module!");return n="password"===$("input",this).attr("type"),i[t]={shielded:n},n&&"true"===$("input",this).attr("unchanged")?i[t].value=r:(e=cryptico.encrypt(r,strPublicKey),i[t].value=e.cipher)}),d={},d[s]=[],$("#event_trigger_params tr.funcMappings").each(function(){return d[s].push({argument:$("div.funcarg",this).text(),value:$("input[type=text]",this).val()})})}if(0===$("#selected_actions tr").length)throw new Error("Please select at least one action or create one!");r={},$("> div",$("#action_dispatcher_params")).each(function(){var e,t;return e=$(".modName",this).text(),t={},$("tr",this).each(function(){var n,r,a,i;if(r=$(".key",this).text(),i=$("input",this).val(),a="password"===$("input",this).attr("type"),""===i)throw $("input",this).focus(),new Error("'"+r+"' missing for '"+e+"'");return t[r]={shielded:a},a&&"true"===$("input",this).attr("unchanged")?t[r].value=i:(n=cryptico.encrypt(i,strPublicKey),t[r].value=n.cipher)}),r[e]=t}),n=[],t={},$("#selected_actions td.title").each(function(){var e,r;return e=$(this).text(),t[e]=[],n.push(e),r=$(this).parent(),$(".funcMappings tr",r).each(function(){return t[e].push({argument:$("div.funcarg",this).text(),value:$("input[type=text]",this).val()})})});try{a=JSON.parse(e.getValue())}catch(f){throw o=f,new Error("Parsing of your conditions failed! Needs to be an Array of Strings!")}if(!(a instanceof Array))throw new Error("Conditions Invalid! Needs to be an Array of Strings!");return u=function(e){return function(t){var n;return 409!==t.status?fFailedRequest(e.id+" not stored!")(t):confirm("Are you sure you want to overwrite the existing rule?")?(n=JSON.parse(e.body),n.overwrite=!0,e.body=JSON.stringify(n),fIssueRequest({command:e.command,data:e,done:function(e){return $("#info").text(e.message),$("#info").attr("class","success")},fail:fFailedRequest(e.id+" not stored!")})):void 0}},"Event Trigger"===$("#select_event_type").val()&&(m=fConvertTimeToDate($("#input_start").val()).toISOString(),p=fConvertDayHourToMinutes($("#input_interval").val())),l={body:JSON.stringify({id:$("#input_id").val(),eventtype:c,eventname:s,eventparams:i,eventstart:m,eventinterval:p,eventfunctions:d,conditions:a,actions:n,actionparams:r,actionfunctions:t})},fIssueRequest({command:"forge_rule",data:l,done:function(e){return $("#info").text(e.message),$("#info").attr("class","success")},fail:u(l)})}catch(f){return o=f,$("#info").text("Error in upload: "+o.message),$("#info").attr("class","error"),alert(o.message)}}),oParams.id?fIssueRequest({command:"get_rule",data:{body:JSON.stringify({id:oParams.id})},done:function(t){var n;return n=JSON.parse(t.message),n?($("#input_id").val(n.id),fPrepareEventType(n.eventtype,function(){var t,r,a,i,o,s,c,d;switch(n.eventtype){case"Event Trigger":$("select",domSelectEventTrigger).val(n.eventname),$("select",domSelectEventTrigger).val()===n.eventname?(fFetchEventParams(n.eventname),a=new Date(n.eventstart),s=a.getMinutes(),1===s.toString().length&&(s="0"+s),$("#input_start",domInputEventTiming).val(a.getHours()+":"+s),$("#input_interval",domInputEventTiming).val(n.eventinterval)):(window.scrollTo(0,0),$("#info").text("Error loading Rule: Your Event Trigger does not exist anymore!"),$("#info").attr("class","error"));break;case"Webhook":$("select",domSelectWebhook).val(n.eventname),$("select",domSelectWebhook).val()===n.eventname&&(window.scrollTo(0,0),$("#info").text("Your Webhook does not exist anymore!"),$("#info").attr("class","error"));break;case"Custom Event":$("input",domInputEventName).val(n.eventname)}for(e.setValue(JSON.stringify(n.conditions,void 0,2)),domSectionSelectedActions.show(),c=n.actions,d=[],i=0,o=c.length;o>i;i++)t=c[i],r=t.split(" -> "),d.push(fAddSelectedAction(t));return d})):void 0},fail:function(e){var t;if(""===e.responseText)t="No Response from Server!";else try{t=JSON.parse(e.responseText).message}catch(n){}return fFailedRequest("Error in upload: "+t)(e)}}):void 0},window.addEventListener("load",fOnLoad,!0);