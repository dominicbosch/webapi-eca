var commandFunctions,db,dynmod,encryption,eventEmitter,events,exports,express,forgeModule,fs,getModuleComment,getModuleParams,getModuleUserArguments,getModuleUserParams,getModules,hasRequiredParams,log,path,rh,router,storeModule,storeRule;log=require("./logging"),db=require("./persistence"),dynmod=require("./dynamic-modules"),encryption=require("./encryption"),rh=require("./request-handler"),fs=require("fs"),path=require("path"),events=require("events"),express=require("express"),eventEmitter=new events.EventEmitter,exports=module.exports,exports.addRuleListener=function(e){return function(e){return eventEmitter.addListener("rule",e),db.getAllActivatedRuleIdsPerUser(function(e,r){var t,n,s,i;t=function(e,r){var t,n,s,i,u;for(t=function(r){return db.getRule(e,r,function(r,t){var n,s;try{if(s=JSON.parse(t),db.resetLog(e,s.id),n="",s.eventstart)return n="Starting at "+new Date(s.eventstart)+", Interval set to "+s.eventinterval+" minutes",db.appendLog(e,s.id,"INIT","Rule '"+s.id+"' initialized. "+n),eventEmitter.emit("rule",{intevent:"init",user:e,rule:s})}catch(i){return r=i,log.warn("CM | There's an invalid rule in the system: "+t)}})},i=[],n=0,s=r.length;s>n;n++)u=r[n],i.push(t(u));return i},n=[];for(i in r)s=r[i],n.push(t(i,s));return n})}}(this),exports.processRequest=function(e,r,t){var n,s;r.body||(r.body="{}");try{n=JSON.parse(r.body)}catch(i){return s=i,t({code:404,message:"You had a strange body in your request!"})}return commandFunctions[r.command](e,n,t)},exports.router=router=express.Router(),router.use(function(e,r,t){return e.session&&e.session.user?t():r.status(401).send("Login first!")}),router.post("get_public_key",function(e,r){var t;return t={code:200,message:encryption.getPublicKey()},r.status(t.code).send(t)}),exports.handleUserCommand=function(e){return function(r,t){var n;return r.session&&r.session.user?(n="",r.on("data",function(e){return n+=e}),r.on("end",function(){var s;return s=qs.parse(n),e.userRequestHandler(r.session.user,s,function(e){return t.send(e.code,e)})})):t.send(401,"Login first!")}}(this),hasRequiredParams=function(e,r){var t,n,s,i;for(t={code:400,message:"Your request didn't contain all necessary fields! Requires: "+e.join()},n=0,s=e.length;s>n;n++)if(i=e[n],!r[i])return t;return t.code=200,t.message="All required properties found",t},getModules=function(e,r,t,n){var s;return s=function(e){return function(r,s){var i,u,o,a,d,c,g,m;if(c={},i=function(){return n({code:200,message:JSON.stringify(c)})},m=s.length,0===m)return i();for(u=function(r){return function(r){return t.getModule(e,r,function(e,t){return t&&(c[r]=JSON.parse(t.functions)),0===--m?i():void 0})}}(this),g=[],a=0,d=s.length;d>a;a++)o=s[a],g.push(u(o));return g}},t.getAvailableModuleIds(e.username,s(e.username))},getModuleParams=function(e,r,t,n){var s;return s=hasRequiredParams(["id"],r),200!==s.code?n(s):t.getModuleField(e.username,r.id,"params",function(e,r){return s.message=r,n(s)})},getModuleComment=function(e,r,t,n){var s;return s=hasRequiredParams(["id"],r),200!==s.code?n(s):t.getModuleField(e.username,r.id,"comment",function(e,r){return s.message=r,n(s)})},getModuleUserParams=function(e,r,t,n){var s;return s=hasRequiredParams(["id"],r),200!==s.code?n(s):t.getUserParams(r.id,e.username,function(e,r){var t,i,u;u=JSON.parse(r);for(t in u)i=u[t],i.shielded||(i.value=encryption.decrypt(i.value));return s.message=JSON.stringify(u),n(s)})},getModuleUserArguments=function(e,r,t,n){var s;return s=hasRequiredParams(["ruleId","moduleId"],r),200!==s.code?n(s):t.getAllModuleUserArguments(e.username,r.ruleId,r.moduleId,function(e,r){return s.message=r,n(s)})},forgeModule=function(e){return function(e,r,t,n,s){var i;return i=hasRequiredParams(["id","params","lang","data"],r),200!==i.code?s(i):r.overwrite?storeModule(e,r,t,n,s):n.getModule(e.username,r.id,function(u,o){return o?(i.code=409,i.message="Module name already existing: "+r.id,s(i)):storeModule(e,r,t,n,s)})}}(this),storeModule=function(e){return function(e,r,t,n,s){var i;return i=r.data,dynmod.compileString(i,e.username,{id:"dummyRule"},r.id,r.lang,t,null,function(t){var i,u,o,a,d;if(i=t.answ,200===i.code){u=[],d=t.module;for(a in d)o=d[a],u.push(a);log.info("CM | Storing new module with functions "+u.join(", ")),i.message=" Module "+r.id+" successfully stored! Found following function(s): "+u,r.functions=JSON.stringify(u),r.functionArgs=JSON.stringify(t.funcParams),r.comment=t.comment,n.storeModule(e.username,r)}return s(i)})}}(this),storeRule=function(e){return function(e,r,t){return db.getRule(r.id,e.username,function(n){var s,i,u,o,a,d,c,g,m,l;u=n.eventname.split(" -> ")[0],db.deleteUserArguments(e.username,r.id,u),m={id:r.id,eventtype:r.eventtype,eventname:r.eventname,eventstart:r.eventstart,eventinterval:r.eventinterval,conditions:r.conditions,actions:r.actions},r.eventstart&&(m.timestamp=(new Date).toISOString()),l=JSON.stringify(m),db.storeRule(e.username,m.id,l),r.eventparams?(u=m.eventname.split(" -> ")[0],db.eventTriggers.storeUserParams(u,e.username,JSON.stringify(r.eventparams))):db.eventTriggers.deleteUserParams(u,e.username),d=r.eventfunctions,db.eventTriggers.deleteUserArguments(e.username,m.id,i[0]);for(a in d)s=d[a],i=a.split(" -> "),db.eventTriggers.storeUserArguments(e.username,m.id,i[0],i[1],JSON.stringify(s));c=r.actionparams;for(a in c)g=c[a],db.actionDispatchers.storeUserParams(a,e.username,JSON.stringify(g));d=r.actionfunctions;for(a in d)s=d[a],i=a.split(" -> "),db.actionDispatchers.storeUserArguments(e.username,m.id,i[0],i[1],JSON.stringify(s));return o="",m.eventstart&&(o="Starting at "+new Date(m.eventstart)+", Interval set to "+m.eventinterval+" minutes"),db.resetLog(e.username,m.id),db.appendLog(e.username,m.id,"INIT","Rule '"+m.id+"' initialized. "+o),eventEmitter.emit("rule",{intevent:"new",user:e.username,rule:m}),t({code:200,message:"Rule '"+m.id+"' stored and activated!"})})}}(this),commandFunctions={get_event_triggers:function(e,r,t){return getModules(e,r,db.eventTriggers,t)},get_full_event_trigger:function(e,r,t){return db.eventTriggers.getModule(e.username,r.id,function(e,r){return t({code:200,message:JSON.stringify(r)})})},get_event_trigger_params:function(e,r,t){return getModuleParams(e,r,db.eventTriggers,t)},get_event_trigger_comment:function(e,r,t){return getModuleComment(e,r,db.eventTriggers,t)},get_event_trigger_user_params:function(e,r,t){return getModuleUserParams(e,r,db.eventTriggers,t)},get_event_trigger_user_arguments:function(e,r,t){return getModuleUserArguments(e,r,db.eventTriggers,t)},get_event_trigger_function_arguments:function(e,r,t){var n;return n=hasRequiredParams(["id"],r),200!==n.code?t(n):db.eventTriggers.getModuleField(e.username,r.id,"functionArgs",function(e,r){return t({code:200,message:r})})},forge_event_trigger:function(e,r,t){return forgeModule(e,r,"eventtrigger",db.eventTriggers,t)},delete_event_trigger:function(e,r,t){var n;return n=hasRequiredParams(["id"],r),200!==n.code?t(n):(db.eventTriggers.deleteModule(e.username,r.id),t({code:200,message:"OK!"}))},get_action_dispatchers:function(e,r,t){return getModules(e,r,db.actionDispatchers,t)},get_full_action_dispatcher:function(e,r,t){var n;return n=hasRequiredParams(["id"],r),200!==n.code?t(n):db.actionDispatchers.getModule(e.username,r.id,function(e,r){return t({code:200,message:JSON.stringify(r)})})},get_action_dispatcher_params:function(e,r,t){return getModuleParams(e,r,db.actionDispatchers,t)},get_action_dispatcher_comment:function(e,r,t){return getModuleComment(e,r,db.actionDispatchers,t)},get_action_dispatcher_user_params:function(e,r,t){return getModuleUserParams(e,r,db.actionDispatchers,t)},get_action_dispatcher_user_arguments:function(e,r,t){return getModuleUserArguments(e,r,db.actionDispatchers,t)},get_action_dispatcher_function_arguments:function(e,r,t){var n;return n=hasRequiredParams(["id"],r),200!==n.code?t(n):db.actionDispatchers.getModuleField(e.username,r.id,"functionArgs",function(e,r){return t({code:200,message:r})})},forge_action_dispatcher:function(e,r,t){return forgeModule(e,r,"actiondispatcher",db.actionDispatchers,t)},delete_action_dispatcher:function(e,r,t){var n;return n=hasRequiredParams(["id"],r),200!==n.code?t(n):(db.actionDispatchers.deleteModule(e.username,r.id),t({code:200,message:"OK!"}))},get_rules:function(e,r,t){return db.getRuleIds(e.username,function(e,r){return t({code:200,message:r})})},get_rule:function(e,r,t){var n;return n=hasRequiredParams(["id"],r),200!==n.code?t(n):db.getRule(e.username,r.id,function(e,r){return t({code:200,message:r})})},get_rule_log:function(e,r,t){var n;return n=hasRequiredParams(["id"],r),200!==n.code?t(n):db.getLog(e.username,r.id,function(e,r){return t({code:200,message:r})})},forge_rule:function(e,r,t){var n;return n=hasRequiredParams(["id","eventname","conditions","actions"],r),200!==n.code?t(n):r.overwrite?storeRule(e,r,t):db.getRule(e.username,r.id,function(s){return function(s,i){return i?(n.code=409,n.message="Rule name already existing: "+r.id,t(n)):storeRule(e,r,t)}}(this))},delete_rule:function(e,r,t){var n;return n=hasRequiredParams(["id"],r),200!==n.code?t(n):(db.deleteRule(e.username,r.id),eventEmitter.emit("rule",{intevent:"del",user:e.username,rule:null,ruleId:r.id}),t({code:200,message:"OK!"}))},create_webhook:function(e,r,t){var n;return n=hasRequiredParams(["hookname"],r),200!==n.code?t(n):db.getAllUserWebhookNames(e.username,function(n){return function(n,s){var i,u,o;i=!1;for(u in s)o=s[u],o===r.hookname&&(i=!0);return i?t({code:409,message:"Webhook already existing: "+r.hookname}):db.getAllWebhookIDs(function(n,s){var i;return i=function(e){var r,t;for(u="",r=t=0;1>=t;r=++t)u+=Math.random().toString(36).substring(2);return e&&e.indexOf(u)>-1&&(u=i(e)),u},u=i(s),db.createWebhook(e.username,u,r.hookname),rh.activateWebhook(e.username,u,r.hookname),t({code:200,message:JSON.stringify({hookid:u,hookname:r.hookname})})})}}(this))},get_all_webhooks:function(e,r,t){return db.getAllUserWebhookNames(e.username,function(e,r){return e?t({code:400,message:"We didn't like your request!"}):(r=JSON.stringify(r)||null,t({code:200,message:r}))})},delete_webhook:function(e,r,t){var n;return n=hasRequiredParams(["hookid"],r),200!==n.code?t(n):(rh.deactivateWebhook(r.hookid),db.deleteWebhook(e.username,r.hookid),t({code:200,message:"OK!"}))}};