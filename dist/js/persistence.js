var IndexedModules,exports,getSetRecords,log,redis,replyHandler,bind=function(e,t){return function(){return e.apply(t,arguments)}};log=require("./logging"),redis=require("redis"),exports=module.exports,exports.init=function(e){return function(t){return log.info("INIT DB"),e.db?void 0:(exports.eventTriggers=new IndexedModules("event-trigger",log),exports.actionDispatchers=new IndexedModules("action-dispatcher",log),exports.initPort(t))}}(this),exports.initPort=function(e){return function(t){var r;return e.connRefused=!1,null!=(r=e.db)&&r.quit(),e.db=redis.createClient(t,"localhost",{connect_timeout:2e3}),e.db.on("error",function(t){return t.message.indexOf("ECONNREFUSED")>-1?(e.connRefused=!0,log.warn("DB | Wrong port?")):log.error(t)}),exports.eventTriggers.setDB(e.db),exports.actionDispatchers.setDB(e.db)}}(this),exports.selectDatabase=function(e){return function(t){return e.db.select(t)}}(this),exports.isConnected=function(e){return function(t){var r,s;return e.db?e.db.connected?t():(s=0,r=function(){var n;return e.connRefused?(null!=(n=e.db)&&n.quit(),t(new Error("DB | Connection refused! Wrong port?"))):e.db.connected?(log.info("DB | Successfully connected to DB!"),t()):s++<10?setTimeout(r,100):t(new Error("DB | Connection to DB failed!"))},setTimeout(r,100)):t(new Error("DB | DB initialization did not occur or failed miserably!"))}}(this),replyHandler=function(e){return function(e){return function(t,r){return t?log.warn(t,"during '"+e+"'"):log.info("DB | "+e+": "+r)}}}(this),exports.pushEvent=function(e){return function(t){return t?(log.info("DB | Event pushed into the queue: '"+t.eventname+"'"),e.db.rpush("event_queue",JSON.stringify(t))):log.warn("DB | Why would you give me an empty event...")}}(this),exports.popEvent=function(e){return function(t){var r;return r=function(e){return function(t,r){var s,n;try{return n=JSON.parse(r),e(t,n)}catch(o){return s=o,e(s)}}},e.db.lpop("event_queue",r(t))}}(this),exports.purgeEventQueue=function(e){return function(){return e.db.del("event_queue",replyHandler("purging event queue"))}}(this),getSetRecords=function(e){return function(t,r,s){return log.info("DB | Fetching set records: '"+t+"'"),e.db.smembers(t,function(e,n){var o,u,i,d,l,a,h;if(e)return log.warn(e,"DB | fetching '"+t+"'"),s(e);if(0===n.length)return s();for(h=n.length,d={},setTimeout(function(){return h>0?s(new Error("Timeout fetching '"+t+"'")):void 0},2e3),o=function(e){return function(t,r){return--h,t?log.warn(t,"DB | fetching single element: '"+e+"'"):r?d[e]=r:log.warn(new Error("Empty key in DB: '"+e+"'")),0===h?s(null,d):void 0}},a=[],u=0,i=n.length;i>u;u++)l=n[u],a.push(r(l,o(l)));return a})}}(this),IndexedModules=function(){function e(e,t){this.setname=e,this.deleteUserArguments=bind(this.deleteUserArguments,this),this.getUserArguments=bind(this.getUserArguments,this),this.getAllModuleUserArguments=bind(this.getAllModuleUserArguments,this),this.getUserArgumentsFunctions=bind(this.getUserArgumentsFunctions,this),this.storeUserArguments=bind(this.storeUserArguments,this),this.deleteUserParams=bind(this.deleteUserParams,this),this.getUserParamsIds=bind(this.getUserParamsIds,this),this.getUserParams=bind(this.getUserParams,this),this.storeUserParams=bind(this.storeUserParams,this),this.deleteModule=bind(this.deleteModule,this),this.getModuleIds=bind(this.getModuleIds,this),this.getAvailableModuleIds=bind(this.getAvailableModuleIds,this),this.getModuleField=bind(this.getModuleField,this),this.getModule=bind(this.getModule,this),this.storeModule=bind(this.storeModule,this),t.info("DB | (IdxedMods) Instantiated indexed modules for '"+this.setname+"'")}return e.prototype.setDB=function(e){return this.db=e,log.info("DB | (IdxedMods) Registered new DB connection for '"+this.setname+"'")},e.prototype.storeModule=function(e,t){return log.info("DB | (IdxedMods) "+this.setname+".storeModule( "+e+", oModule )"),this.db.sadd(this.setname+"s",t.id,replyHandler("sadd '"+this.setname+"s' -> "+t.id)),this.db.hmset(this.setname+":"+t.id,t,replyHandler("hmset '"+this.setname+":"+t.id+"' -> [oModule]"))},e.prototype.getModule=function(e,t,r){return log.info("DB | (IdxedMods) "+this.setname+".getModule( "+e+", "+t+" )"),log.info("hgetall "+this.setname+":"+t),this.db.hgetall(this.setname+":"+t,r)},e.prototype.getModuleField=function(e,t,r,s){return log.info("DB | (IdxedMods) "+this.setname+".getModuleField( "+e+", "+t+", "+r+" )"),this.db.hget(this.setname+":"+t,r,s)},e.prototype.getAvailableModuleIds=function(e,t){return log.info("DB | (IdxedMods) "+this.setname+".getAvailableModuleIds( "+e+" )"),this.db.sunion("public-"+this.setname+"s",this.setname+"s",t)},e.prototype.getModuleIds=function(e,t){return log.info("DB | (IdxedMods) "+this.setname+".getModuleIds()"),this.db.smembers(this.setname+"s",t)},e.prototype.deleteModule=function(e,t){return log.info("DB | (IdxedMods) "+this.setname+".deleteModule( "+e+", "+t+" )"),this.db.srem(this.setname+"s",t,replyHandler("srem '"+this.setname+"s' -> '"+t+"'")),this.db.del(this.setname+":"+t,replyHandler("del '"+this.setname+":"+t+"'")),this.deleteUserParams(t,e),exports.getRuleIds(e,function(r){return function(s,n){var o,u,i,d;for(i=[],o=0,u=n.length;u>o;o++)d=n[o],i.push(r.getUserArgumentsFunctions(e,d,t,function(s,n){return r.deleteUserArguments(e,d,t)}));return i}}(this))},e.prototype.storeUserParams=function(e,t,r){return log.info("DB | (IdxedMods) "+this.setname+".storeUserParams( "+e+", "+t+", encData )"),this.db.sadd(this.setname+"-params",e+":"+t,replyHandler("sadd '"+this.setname+"-params' -> '"+e+":"+t+"'")),this.db.set(this.setname+"-params:"+e+":"+t,r,replyHandler("set '"+this.setname+"-params:"+e+":"+t+"' -> [encData]"))},e.prototype.getUserParams=function(e,t,r){return log.info("DB | (IdxedMods) "+this.setname+".getUserParams( "+e+", "+t+" )"),this.db.get(this.setname+"-params:"+e+":"+t,r)},e.prototype.getUserParamsIds=function(e){return log.info("DB | (IdxedMods) "+this.setname+".getUserParamsIds()"),this.db.smembers(this.setname+"-params",e)},e.prototype.deleteUserParams=function(e,t){return log.info("DB | (IdxedMods) "+this.setname+".deleteUserParams( "+e+", "+t+" )"),this.db.srem(this.setname+"-params",e+":"+t,replyHandler("srem '"+this.setname+"-params' -> '"+e+":"+t+"'")),this.db.del(this.setname+"-params:"+e+":"+t,replyHandler("del '"+this.setname+"-params:"+e+":"+t+"'"))},e.prototype.storeUserArguments=function(e,t,r,s,n){return log.info("DB | (IdxedMods) "+this.setname+".storeUserArguments( "+e+", "+t+", "+r+", "+s+", encData )"),this.db.sadd(this.setname+":"+e+":"+t+":"+r+":functions",s,replyHandler("sadd '"+this.setname+":"+e+":"+t+":"+r+":functions' -> '"+s+"'")),this.db.set(this.setname+":"+e+":"+t+":"+r+":function:"+s,n,replyHandler("set '"+this.setname+":"+e+":"+t+":"+r+":function:"+s+"' -> [encData]"))},e.prototype.getUserArgumentsFunctions=function(e,t,r,s){return log.info("DB | (IdxedMods) "+this.setname+".getUserArgumentsFunctions( "+e+", "+t+", "+r+" )"),this.db.get(this.setname+":"+e+":"+t+":"+r+":functions",s)},e.prototype.getAllModuleUserArguments=function(e,t,r,s){return log.info("DB | (IdxedMods) "+this.setname+".getAllModuleUserArguments( "+e+", "+t+", "+r+" )"),this.db.smembers(this.setname+":"+e+":"+t+":"+r+":functions",function(n){return function(o,u){var i,d,l,a,h,g,f;if(f=u.length,h={},0===f)return s(null,h);for(g=[],l=0,a=u.length;a>l;l++)d=u[l],i=function(e){return function(t,r){return r&&(h[e]=r),0===--f?s(null,h):void 0}},g.push(n.db.get(n.setname+":"+e+":"+t+":"+r+":function:"+d,i(d)));return g}}(this))},e.prototype.getUserArguments=function(e,t,r,s,n){return log.info("DB | (IdxedMods) "+this.setname+".getUserArguments( "+e+", "+t+", "+r+", "+s+" )"),this.db.get(this.setname+":"+e+":"+t+":"+r+":function:"+s,n)},e.prototype.deleteUserArguments=function(e,t,r){return log.info("DB | (IdxedMods) "+this.setname+".deleteUserArguments( "+e+", "+t+", "+r+" )"),this.db.smembers(this.setname+":"+e+":"+t+":"+r+":functions",function(s){return function(n,o){var u,i,d,l;for(l=[],i=0,d=o.length;d>i;i++)u=o[i],l.push(s.db.del(s.setname+":"+e+":"+t+":"+r+":function:"+u,replyHandler("del '"+s.setname+":"+e+":"+t+":"+r+":function:"+u+"'")));return l}}(this))},e}(),exports.appendLog=function(e){return function(t,r,s,n){return e.db.append(t+":"+r+":log","[UTC|"+(new Date).toISOString()+"] {"+s+"} "+n.substring(0,1e3)+"\n")}}(this),exports.getLog=function(e){return function(t,r,s){return e.db.get(t+":"+r+":log",s)}}(this),exports.resetLog=function(e){return function(t,r){return e.db.del(t+":"+r+":log",replyHandler("del '"+t+":"+r+":log'"))}}(this),exports.getRule=function(e){return function(t,r,s){return log.info("DB | getRule( '"+t+"', '"+r+"' )"),e.db.get("user:"+t+":rule:"+r,s)}}(this),exports.storeRule=function(e){return function(t,r,s){return log.info("DB | storeRule( '"+t+"', '"+r+"' )"),e.db.sadd("user:"+t+":rules",""+r,replyHandler("sadd 'user:"+t+":rules' -> '"+r+"'")),e.db.set("user:"+t+":rule:"+r,s,replyHandler("set 'user:"+t+":rule:"+r+"' -> [data]"))}}(this),exports.getRuleIds=function(e){return function(t,r){return log.info("DB | getRuleIds( '"+t+"' )"),e.db.smembers("user:"+t+":rules",r)}}(this),exports.deleteRule=function(e){return function(t,r){return log.info("DB | deleteRule( '"+t+"', '"+r+"' )"),e.db.srem("user:"+t+":rules",r,replyHandler("srem 'user:"+t+":rules' -> '"+r+"'")),e.db.del("user:"+t+":rule:"+r,replyHandler("del 'user:"+t+":rule:"+r+"'"))}}(this),exports.getAllActivatedRuleIdsPerUser=function(e){return function(t){return log.info("DB | Fetching all active rules"),e.db.smembers("users",function(r,s){var n,o,u,i,d,l,a;if(i={},0===s.length)return t(null,i);for(l=s.length,d=[],o=0,u=s.length;u>o;o++)a=s[o],n=function(e){return function(r){return function(r,s){return s.length>0&&(i[e]=s),0===--l?t(null,i):void 0}}(this)},d.push(e.db.smembers("user:"+a+":rules",n(a)));return d})}}(this),exports.storeUser=function(e){return function(t){return log.info("DB | storeUser: '"+t.username+"'"),t&&t.username&&t.password?(e.db.sadd("users",t.username,replyHandler("sadd 'users' -> '"+t.username+"'")),e.db.hmset("user:"+t.username,t,replyHandler("hmset 'user:"+t.username+"' -> [objUser]")),e.db.hset("user:"+t.username,"roles",JSON.stringify(t.roles),replyHandler("hset 'user:"+t.username+"' field 'roles' -> [objUser]"))):log.warn(new Error("DB | username or password was missing"))}}(this),exports.getUserIds=function(e){return function(t){return log.info("DB | getUserIds"),e.db.smembers("users",t)}}(this),exports.getUser=function(e){return function(t,r){return log.info("DB | getUser: '"+t+"'"),e.db.hgetall("user:"+t,function(e,t){try{t.roles=JSON.parse(t.roles)}catch(s){}return r(e,t)})}}(this),exports.deleteUser=function(e){return function(t){return log.info("DB | deleteUser: '"+t+"'"),e.db.srem("users",t,replyHandler("srem 'users' -> '"+t+"'")),e.db.del("user:"+t,replyHandler("del 'user:"+t+"'")),e.db.smembers("user:"+t+":rules",function(r,s){var n,o,u,i,d;for(n=function(r){return e.db.srem("rule:"+r+":users",t,replyHandler("srem 'rule:"+r+":users' -> '"+t+"'"))},d=[],o=0,i=s.length;i>o;o++)u=s[o],d.push(n(u));return d}),e.db.del("user:"+t+":rules",replyHandler("del 'user:"+t+":rules'")),e.db.smembers("user:"+t+":active-rules",function(r,s){var n,o,u,i,d;for(n=function(r){return e.db.srem("rule:"+r+":active-users",t,replyHandler("srem 'rule:"+r+":active-users' -> '"+t+"'"))},d=[],o=0,i=s.length;i>o;o++)u=s[o],d.push(n(u));return d}),e.db.del("user:"+t+":active-rules",replyHandler("del user:"+t+":active-rules")),e.db.smembers("user:"+t+":roles",function(r,s){var n,o,u,i,d;for(n=function(r){return e.db.srem("role:"+r+":users",t,replyHandler("srem 'role:"+r+":users' -> '"+t+"'"))},d=[],o=0,i=s.length;i>o;o++)u=s[o],d.push(n(u));return d}),e.db.del("user:"+t+":roles",replyHandler("del 'user:"+t+":roles'"))}}(this),exports.loginUser=function(e){return function(t,r,s){var n;return log.info("DB | User '"+t+"' tries to log in"),n=function(e){return function(t,r){return t?s(t,null):r&&r.password?e===r.password?(log.info("DB | User '"+r.username+"' logged in!"),r.roles=JSON.parse(r.roles),s(null,r)):s(new Error("Wrong credentials!"),null):s(new Error("User not found!"),null)}},e.db.hgetall("user:"+t,n(r))}}(this),exports.storeUserRole=function(e){return function(t,r){return log.info("DB | storeUserRole: '"+t+":"+r+"'"),e.db.sadd("roles",r,replyHandler("sadd '"+r+"' to 'roles'")),e.db.sadd("user:"+t+":roles",r,replyHandler("sadd 'user:"+t+":roles' -> '"+r+"'")),e.db.sadd("role:"+r+":users",t,replyHandler("sadd 'role:"+r+":users' -> '"+t+"'"))}}(this),exports.deleteRole=function(e){return function(t){return log.info("DB | deleteRole: '"+t+"'"),e.db.smembers("role:"+t+":users",function(r,s){var n,o,u,i,d;for(n=function(r){return e.db.srem("user:"+r+":roles",t,replyHandler("srem 'user:"+r+":roles' -> '"+t+"'"))},d=[],o=0,i=s.length;i>o;o++)u=s[o],d.push(n(u));return d}),e.db.srem("roles",t,replyHandler("srem 'roles' -> '"+t+"'"))}}(this),exports.getUserRoles=function(e){return function(t,r){return log.info("DB | getUserRoles: '"+t+"'"),e.db.smembers("user:"+t+":roles",r)}}(this),exports.getRoleUsers=function(e){return function(t,r){return log.info("DB | getRoleUsers: '"+t+"'"),e.db.smembers("role:"+t+":users",r)}}(this),exports.removeUserRole=function(e){return function(t,r){return log.info("DB | removeRoleFromUser: role '"+r+"', user '"+t+"'"),e.db.srem("user:"+t+":roles",r,replyHandler("srem 'user:"+t+":roles' -> '"+r+"'")),e.db.srem("role:"+r+":users",t,replyHandler("srem 'role:"+r+":users' -> '"+t+"'"))}}(this),exports.createWebhook=function(e){return function(t,r,s){return e.db.sadd("webhooks",r,replyHandler("sadd 'webhooks' -> '"+r+"'")),e.db.sadd("user:"+t+":webhooks",r,replyHandler("sadd 'user:"+t+":webhooks' -> '"+r+"'")),e.db.hmset("webhook:"+r,"hookname",s,"username",t,replyHandler("set webhook:"+r+" -> ["+s+", "+t+"]"))}}(this),exports.getWebhookName=function(e){return function(t,r){return e.db.hget("webhook:"+t,"hookname",r)}}(this),exports.getFullWebhook=function(e){return function(t,r){return e.db.hgetall("webhook:"+t,r)}}(this),exports.getUserWebhookIDs=function(e){return function(t,r){return e.db.smembers("user:"+t+":webhooks",r)}}(this),exports.getAllUserWebhookNames=function(e){return function(e,t){return getSetRecords("user:"+e+":webhooks",exports.getWebhookName,t)}}(this),exports.getAllWebhookIDs=function(e){return function(t){return e.db.smembers("webhooks",t)}}(this),exports.getAllWebhooks=function(e){return function(e){return getSetRecords("webhooks",exports.getFullWebhook,e)}}(this),exports.deleteWebhook=function(e){return function(t,r){return e.db.srem("webhooks",r,replyHandler("srem 'webhooks' -> '"+r+"'")),e.db.srem("user:"+t+":webhooks",r,replyHandler("srem 'user:"+t+":webhooks' -> '"+r+"'")),e.db.del("webhook:"+r,replyHandler("del webhook:"+r))}}(this),exports.shutDown=function(e){return function(){var t;return null!=(t=e.db)?t.quit():void 0}}(this);