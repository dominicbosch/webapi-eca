var crypto,db,dirHandlers,exports,fs,log,path,pathUsers;log=require("./logging"),db=require("./persistence"),fs=require("fs"),path=require("path"),crypto=require("crypto-js"),pathUsers=path.resolve(__dirname,"..","config","users.json"),dirHandlers=path.resolve(__dirname,"..","webpages","handlers"),exports=module.exports,exports.init=function(){var e,n,r,o;o=JSON.parse(fs.readFileSync(pathUsers,"utf8")),e=function(e,n){return n.username=e,db.storeUser(n)};for(r in o)n=o[r],e(r,n);return this.allowedHooks={},db.getAllWebhooks(function(e){return function(n,r){return r?(log.info("RH | Initializing "+Object.keys(r).length+" Webhooks"),e.allowedHooks=r):void 0}}(this))},this.objAdminCmds={shutdown:function(e,n){var r;return r={code:200,message:"Shutting down... BYE!"},setTimeout(process.exit,500),n(null,r)},newuser:function(e,n){var r,o,s,t,a;if(r={code:200,message:"User stored thank you!"},e.username&&e.password){if(e.roles)try{a=JSON.parse(e.roles)}catch(i){o=i,log("RH | error parsing newuser roles: "+o.message),a=[]}else a=[];t={username:e.username,password:e.password,roles:a},db.storeUser(t),s=function(e,n,r){return function(o,s){var t;return t=JSON.parse(s),t[e]={password:n,roles:r},fs.writeFile(pathUsers,JSON.stringify(t,void 0,2),"utf8",function(e){return e?(log.error("RH | Unable to write new user file! "),log.error(e)):void 0})}},fs.readFile(pathUsers,"utf8",s(e.username,e.password,a))}else r.code=401,r.message="Missing parameter for this command";return n(null,r)}},exports.handleEvent=function(e,n){var r;return r="",e.on("data",function(e){return r+=e}),e.on("end",function(){var e,o,s;try{s=JSON.parse(r)}catch(t){o=t,n.send(400,"Badly formed event!")}return s&&s.eventname&&!o?(e={code:200,message:"Thank you for the event: "+s.eventname},n.send(e.code,e),db.pushEvent(s)):n.send(400,"Your event was missing important parameters!")})},exports.handleForge=function(e,n){var r;return r=e.query.page,e.session.user||(r="login"),renderPage(r,e,n)},exports.handleAdminCommand=function(e){return function(n,r){var o;return n.session&&n.session.user&&n.session.user.roles.indexOf("admin")>-1?(o="",n.on("data",function(e){return o+=e}),n.on("end",function(){var n,s,t,a,i,u,d,l;if(console.log("RH | body is "+typeof o),l=o,e.log.info("RH | Received admin request: "+l.command),n=l.command.split(" "),n[0]&&e.objAdminCmds[n[0]]){for(t=n.slice(1),d={},a=0,u=t.length;u>a;a++)i=t[a],s=i.split(":"),2===s.length&&(d[s[0]]=s[1]);return e.objAdminCmds[n[0]](d,function(e,n){return r.send(n.code,n)})}return r.send(404,"Command unknown!")})):r.send(401,"You need to be logged in as admin!")}}(this),exports.handleWebhooks=function(e){return function(n,r){var o,s,t;return s=n.url.substring(10).split("/")[0],t=e.allowedHooks[s],t?(o="",n.on("data",function(e){return o+=e}),n.on("end",function(){var e;return e={eventname:t.hookname,body:o},t.username&&(e.username=t.username),db.pushEvent(e),r.send(200,JSON.stringify({message:"Thank you for the event: '"+t.hookname+"'",evt:e}))})):r.send(404,"Webhook not existing!")}}(this),exports.activateWebhook=function(e){return function(n,r,o){return e.log.info("HL | Webhook '"+r+"' activated"),e.allowedHooks[r]={hookname:o,username:n}}}(this),exports.deactivateWebhook=function(e){return function(n){return e.log.info("HL | Webhook '"+n+"' deactivated"),delete e.allowedHooks[n]}}(this);