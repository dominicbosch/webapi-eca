var db,dynmod,exports,isRunning,jsonQuery,listUserRules,log,numExecutingFunctions,oOperators,pollQueue,processEvent,updateActionModules,validConditions;log=require("./logging"),db=require("./persistence"),dynmod=require("./dynamic-modules"),jsonQuery=require("js-select"),listUserRules={},isRunning=!1,exports=module.exports,exports.init=function(e){return function(){return isRunning?void 0:(setTimeout(exports.startEngine,10),module.exports)}}(this),exports.getListUserRules=function(){return listUserRules},exports.startEngine=function(){return isRunning?void 0:(isRunning=!0,pollQueue())},exports.internalEvent=function(e){return function(e){var n,t;return listUserRules[e.user]||"del"===e.intevent||(listUserRules[e.user]={}),t=listUserRules[e.user],n=e.rule,("new"===e.intevent||"init"===e.intevent&&!t[n.id])&&(t[n.id]={rule:n,actions:{}},updateActionModules(n.id)),"del"===e.intevent&&t&&delete t[e.ruleId],"{}"===JSON.stringify(t)?delete listUserRules[e.user]:void 0}}(this),updateActionModules=function(e){return function(e){var n,t,r,o,i,u;t=function(n){var t,r,o;if(r=function(t){var r,o,i,u;for(u=n[e].rule.actions,o=0,i=u.length;i>o;o++)if(r=u[o],r.split(" -> ")[0]===t)return!0;return!1},n[e]){o=[];for(t in n[e].rule.actions)o.push(r(t)?void 0:delete n[e].actions[t]);return o}};for(r in listUserRules)o=listUserRules[r],t(o);n=function(n,t){var r,o,i,u;r=function(t){var r,o,i,u,s,l;for(o=function(r){var o;return o=r.split(" -> ")[0],t.actions[o]&&t.rule.id!==e?void 0:db.actionDispatchers.getModule(n,o,function(e,r){return r?dynmod.compileString(r.data,n,t.rule,o,r.lang,"actiondispatcher",db.actionDispatchers,function(e){return 200===e.answ.code?log.info("EN | Module '"+o+"' successfully loaded for userName '"+n+"' in rule '"+t.rule.id+"'"):log.error("EN | Compilation of code failed! "+n+", "+t.rule.id+", "+o+": "+e.answ.message),t.actions[o]=e}):log.warn("EN | "+o+" not found for "+t.rule.id+"!")})},s=t.rule.actions,l=[],i=0,u=s.length;u>i;i++)r=s[i],l.push(o(r));return l},u=[];for(o in t)i=t[o],u.push(r(i));return u},i=[];for(u in listUserRules)o=listUserRules[u],i.push(n(u,o));return i}}(this),numExecutingFunctions=1,pollQueue=function(){return isRunning?(db.popEvent(function(e,n){return!e&&n?processEvent(n):void 0}),setTimeout(pollQueue,20*numExecutingFunctions)):void 0},oOperators={"<":function(e,n){return n>e},"<=":function(e,n){return n>=e},">":function(e,n){return e>n},">=":function(e,n){return e>=n},"==":function(e,n){return e===n},"!=":function(e,n){return e!==n},instr:function(e,n){return e.indexOf(n)>-1}},validConditions=function(e,n,t,r){var o,i,u,s,l,c,a,d;if(0===n.conditions.length)return!0;for(c=n.conditions,u=0,s=c.length;s>u;u++){if(o=c[u],a=jsonQuery(e,o.selector).nodes(),0===a.length)return db.appendLog(t,r,"Condition","Node not found in event: "+o.selector),!1;if(l=oOperators[o.operator],!l)return db.appendLog(t,r,"Condition","Unknown operator: "+o.operator+". Use one of "+Object.keys(oOperators).join(", ")),!1;try{if("string"===o.type?d=a[0]:"bool"===o.type?d=a[0]:"value"===o.type&&(d=parseFloat(a[0])||0),!l(d,o.compare))return!1}catch(f){i=f,db.appendLog(t,r,"Condition","Error: Selector '"+o.selector+"', Operator "+o.operator+", Compare: "+o.compare)}}return!0},processEvent=function(e){return function(n){var t,r,o,i,u;if(r=function(n,t,o,i,u){var s,l,c,a,d,f,p,g,v,m,h,E,R;if(!n)return void log.error("EN | Didn't find property in user rule list: "+t.join(", ")+" at depth "+u);if(u!==t.length)return r(n[t[u]],t,o,i,u+1);try{if(numExecutingFunctions++,log.info("EN | "+o+" executes..."),l=[],n.funcArgs[o])for(h=n.funcArgs[o],f=0,g=h.length;g>f;f++){if(m=h[f],c=m.value.match(/#\{(.*?)\}/g),s=m.value,c)for(p=0,v=c.length;v>p;p++)E=c[p],R=E.substring(2,E.length-1),a=jsonQuery(i.body,R).nodes()[0],s=s.replace(E,a),m.value===E&&(s=a);l.push(s)}else log.warn("EN | Weird! arguments not loaded for function '"+o+"'!"),l.push(null);l.push(i),n.module[o].apply(e,l),log.info("EN | "+o+" finished execution")}catch(y){d=y,log.info("EN | ERROR IN ACTION INVOKER: "+d.message),n.logger(d.message)}return numExecutingFunctions--%100===0?log.warn("EN | The system is producing too many tokens! Currently: "+numExecutingFunctions):void 0},log.info("EN | Processing event: "+n.eventname),t=function(e,t){var o,i,u,s,l,c;s=[];for(c in t)u=t[c],l=u.rule.eventname,u.rule.timestamp&&(l+="_created:"+u.rule.timestamp),n.eventname===l&&validConditions(n,u.rule,e,c)?(log.info("EN | EVENT FIRED: "+n.eventname+" for rule "+c),s.push(function(){var t,s,l,a;for(l=u.rule.actions,a=[],t=0,s=l.length;s>t;t++)o=l[t],i=o.split(" -> "),a.push(r(listUserRules,[e,c,"actions",i[0]],i[1],n,0));return a}())):s.push(void 0);return s},n.username)return t(n.username,listUserRules[n.username]);i=[];for(u in listUserRules)o=listUserRules[u],i.push(t(u,o));return i}}(this),exports.shutDown=function(){return isRunning=!1,listUserRules={}};