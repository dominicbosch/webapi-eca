var config,db,dynmod,encryption,fCallFunction,fCheckAndRun,fLoadModule,init,isRunning,listUserModules,log,pollLoop;log=require("./logging"),config=require("./config"),db=require("./persistence"),dynmod=require("./dynamic-modules"),encryption=require("./encryption"),init=function(e){return e||(console.error("Not all arguments have been passed!"),process.exit()),log.init(e),log.info("EP | Event Trigger Poller starts up"),process.on("uncaughtException",function(e){return log.error("CURRENT STATE:"),log.error(JSON.stringify(this.currentState,null,2)),log.error("Probably one of the Event Triggers produced an error!"),log.error(e)}),db.init(e["db-port"]),db.selectDatabase(e["db-select"]),encryption.init(e.keygenpp)},listUserModules={},isRunning=!0,process.on("disconnect",function(){return log.warn("EP | Shutting down Event Trigger Poller"),isRunning=!1,process.exit()}),process.on("message",function(e){return"startup"===e.intevent&&init(e.data),log.info("EP | Got info about new rule: "+e.intevent),("new"===e.intevent||"init"===e.intevent)&&fLoadModule(e),"del"===e.intevent&&(delete listUserModules[e.user][e.ruleId],"{}"===JSON.stringify(listUserModules[e.user]))?delete listUserModules[e.user]:void 0}),fLoadModule=function(e){var n,r;return n=e.rule.eventname.split(" -> "),r=function(){return db.eventTriggers.getModule(e.user,n[0],function(r,t){return t?dynmod.compileString(t.data,e.user,e.rule,n[0],t.lang,"eventtrigger",db.eventTriggers,function(r){var t,o,i,l;return 200===!r.answ&&log.error("EP | Compilation of code failed! "+e.user+", "+e.rule.id+", "+n[0]),listUserModules[e.user]||(listUserModules[e.user]={}),i=listUserModules[e.user],i[e.rule.id]={id:e.rule.eventname,timestamp:e.rule.timestamp,pollfunc:n[1],funcArgs:r.funcArgs,eventinterval:60*e.rule.eventinterval*1e3,module:r.module,logger:r.logger},l=new Date(e.rule.eventstart?e.rule.eventstart:e.rule.timestamp),t=new Date,o=new Date,t>l?(t.setMilliseconds(0),t.setSeconds(l.getSeconds()),t.setMinutes(l.getMinutes()),t.setHours(l.getHours()),o>t&&(log.info("SETTING NEW INTERVAL: "+(t.getDate()+1)),t.setDate(t.getDate()+1))):t=l,log.info("EP | New event module '"+n[0]+"' loaded for user "+e.user+", in rule "+e.rule.id+", registered at UTC|"+e.rule.timestamp+", starting at UTC|"+l.toISOString()+" ( which is in "+(t-o)/1e3/60+" minutes ) and polling every "+e.rule.eventinterval+" minutes"),e.rule.eventstart?setTimeout(fCheckAndRun(e.user,e.rule.id,e.rule.timestamp),t-o):fCheckAndRun(e.user,e.rule.id,e.rule.timestamp)}):log.info("EP | No module retrieved for "+n[0]+", must be a custom event or Webhook")})},"new"!==e.intevent&&listUserModules[e.user]&&listUserModules[e.user][e.rule.id]?void 0:r()},fCheckAndRun=function(e,n,r){return function(){var t,o;if(log.info("EP | Check and run user "+e+", rule "+n),isRunning&&listUserModules[e]&&listUserModules[e][n]){if(listUserModules[e][n].timestamp===r){o=listUserModules[e][n];try{fCallFunction(e,n,o)}catch(i){t=i,log.error("Error during execution of poller")}return setTimeout(fCheckAndRun(e,n,r),o.eventinterval)}return log.info("EP | We found a newer polling interval and discontinue this one which was created at UTC|"+r)}}},fCallFunction=function(e,n,r){var t,o,i,l,u,s;try{if(t=[],r.funcArgs&&r.funcArgs[r.pollfunc])for(s=r.funcArgs[r.pollfunc],i=0,l=s.length;l>i;i++)u=s[i],t.push(u.value);return this.currentState={rule:n,func:r.pollfunc,user:e},r.module[r.pollfunc].apply(this,t)}catch(d){throw o=d,log.info("EP | ERROR in module when polled: "+r.id+" "+e+": "+o.message),o}},console.log("Do we really need a poll loop in the trigger poller?"),(pollLoop=function(){return isRunning?setTimeout(pollLoop,1e4):void 0})();